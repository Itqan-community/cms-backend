#!/bin/bash

set -o errexit
set -o pipefail
set -o nounset

if [ -z "${POSTGRES_USER}" ]; then
    base_postgres_image_default_user='postgres'
    export POSTGRES_USER="${base_postgres_image_default_user}"
fi
export DATABASE_URL="postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}"

# Function to wait for database
wait_for_db() {
    local host=$1
    local port=$2
    local timeout=${3:-30}

    echo "Waiting for database at ${host}:${port}..."

    for i in $(seq 1 $timeout); do
        if nc -z "$host" "$port" 2>/dev/null; then
            echo "Database is available!"
            return 0
        fi
        echo "Waiting for database... (${i}/${timeout})"
        sleep 1
    done

    echo "Database connection timeout after ${timeout} seconds"
    exit 1
}

# Wait for PostgreSQL
wait_for_db "${POSTGRES_HOST}" "${POSTGRES_PORT}" 30

>&2 echo 'PostgreSQL is available'

exec "$@"
