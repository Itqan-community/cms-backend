<!-- Role Management Component - ADMIN-005 -->
<div class="role-management">
  <!-- Header -->
  <div class="role-header">
    <nz-breadcrumb>
      <nz-breadcrumb-item>
        <nz-icon nzType="home"></nz-icon>
        <span>{{ i18n.t()('navigation.dashboard') }}</span>
      </nz-breadcrumb-item>
      <nz-breadcrumb-item>
        <nz-icon nzType="team"></nz-icon>
        <span>{{ i18n.t()('navigation.role_management') }}</span>
      </nz-breadcrumb-item>
    </nz-breadcrumb>

    <div class="header-actions">
      <button nz-button nzType="default" (click)="loadData()">
        <nz-icon nzType="reload"></nz-icon>
        {{ i18n.t()('common.refresh') }}
      </button>
      <button nz-button nzType="primary" (click)="openRoleModal()">
        <nz-icon nzType="plus"></nz-icon>
        {{ i18n.t()('role.create_role') }}
      </button>
    </div>
  </div>

  <!-- Content -->
  <div class="role-content">
    <!-- Statistics Card -->
    <nz-card class="stats-card" [nzLoading]="loading()">
      <div nz-row [nzGutter]="[16, 16]">
        <div nz-col [nzSpan]="6">
          <nz-statistic 
            [nzTitle]="i18n.t()('stats.total_users')" 
            [nzValue]="userStats()?.total_users || 0"
            nzPrefix="user">
          </nz-statistic>
        </div>
        <div nz-col [nzSpan]="6">
          <nz-statistic 
            [nzTitle]="i18n.t()('stats.active_users')" 
            [nzValue]="userStats()?.active_users || 0"
            nzPrefix="user-check">
          </nz-statistic>
        </div>
        <div nz-col [nzSpan]="6">
          <nz-statistic 
            [nzTitle]="i18n.t()('stats.total_roles')" 
            [nzValue]="userStats()?.roles_count || 0"
            nzPrefix="team">
          </nz-statistic>
        </div>
        <div nz-col [nzSpan]="6">
          <nz-statistic 
            [nzTitle]="i18n.t()('stats.inactive_users')" 
            [nzValue]="userStats()?.inactive_users || 0"
            nzPrefix="user-delete">
          </nz-statistic>
        </div>
      </div>
    </nz-card>

    <!-- Main Content Tabs -->
    <nz-card class="role-tabs-card">
      <nz-tabset [(nzSelectedIndex)]="currentTab" nzType="card">
        
        <!-- Roles Tab -->
        <nz-tab [nzTitle]="i18n.t()('tabs.roles')">
          <div class="tab-content">
            <nz-table 
              #rolesTable 
              [nzData]="roles()" 
              [nzLoading]="loading()"
              nzSize="middle"
              [nzPageSize]="10">
              <thead>
                <tr>
                  <th>{{ i18n.t()('role.name') }}</th>
                  <th>{{ i18n.t()('role.description') }}</th>
                  <th>{{ i18n.t()('role.users_count') }}</th>
                  <th>{{ i18n.t()('role.permissions') }}</th>
                  <th>{{ i18n.t()('common.status') }}</th>
                  <th>{{ i18n.t()('common.actions') }}</th>
                </tr>
              </thead>
              <tbody>
                <tr *nzFor="let role of rolesTable.data">
                  <td>
                    <nz-tag [nzColor]="getRoleColor(role.name)">
                      {{ role.name }}
                    </nz-tag>
                  </td>
                  <td>{{ role.description }}</td>
                  <td>
                    <nz-statistic 
                      [nzValue]="role.user_count" 
                      [nzValueStyle]="{ fontSize: '14px' }">
                    </nz-statistic>
                  </td>
                  <td>
                    <span *nzFor="let category of role.permission_categories">
                      <nz-tag nzColor="blue" class="permission-tag">{{ category }}</nz-tag>
                    </span>
                  </td>
                  <td>
                    <nz-tag [nzColor]="role.is_active ? 'green' : 'red'">
                      {{ role.is_active ? i18n.t()('common.active') : i18n.t()('common.inactive') }}
                    </nz-tag>
                  </td>
                  <td class="action-buttons">
                    <button 
                      nz-button 
                      nzType="text" 
                      nzSize="small"
                      (click)="openRoleModal(role)"
                      nz-tooltip 
                      [nzTooltipTitle]="i18n.t()('common.edit')">
                      <nz-icon nzType="edit"></nz-icon>
                    </button>
                    <button 
                      nz-button 
                      nzType="text" 
                      nzSize="small"
                      (click)="openPermissionModal(role)"
                      nz-tooltip 
                      [nzTooltipTitle]="i18n.t()('permissions.manage')">
                      <nz-icon nzType="key"></nz-icon>
                    </button>
                    <button 
                      nz-button 
                      nzType="text" 
                      nzSize="small"
                      nz-popconfirm
                      [nzPopconfirmTitle]="i18n.t()('role.reset_confirm')"
                      (nzOnConfirm)="resetRoleToDefault(role)"
                      nz-tooltip 
                      [nzTooltipTitle]="i18n.t()('role.reset_to_default')">
                      <nz-icon nzType="undo"></nz-icon>
                    </button>
                    <button 
                      nz-button 
                      nzType="text" 
                      nzSize="small"
                      nzDanger
                      nz-popconfirm
                      [nzPopconfirmTitle]="i18n.t()('role.delete_confirm')"
                      (nzOnConfirm)="deleteRole(role)"
                      [disabled]="role.user_count > 0"
                      nz-tooltip 
                      [nzTooltipTitle]="i18n.t()('common.delete')">
                      <nz-icon nzType="delete"></nz-icon>
                    </button>
                  </td>
                </tr>
              </tbody>
            </nz-table>

            <nz-empty *ngIf="roles().length === 0 && !loading()" 
              [nzNotFoundContent]="i18n.t()('role.no_roles_found')">
            </nz-empty>
          </div>
        </nz-tab>

        <!-- Users Tab -->
        <nz-tab [nzTitle]="i18n.t()('tabs.users')">
          <div class="tab-content">
            <div class="tab-header">
              <button nz-button nzType="primary" (click)="openUserModal()">
                <nz-icon nzType="user-add"></nz-icon>
                {{ i18n.t()('user.create_user') }}
              </button>
            </div>

            <nz-table 
              #usersTable 
              [nzData]="users()" 
              [nzLoading]="loading()"
              nzSize="middle"
              [nzPageSize]="10">
              <thead>
                <tr>
                  <th>{{ i18n.t()('user.name') }}</th>
                  <th>{{ i18n.t()('user.email') }}</th>
                  <th>{{ i18n.t()('user.role') }}</th>
                  <th>{{ i18n.t()('user.last_login') }}</th>
                  <th>{{ i18n.t()('common.status') }}</th>
                  <th>{{ i18n.t()('common.actions') }}</th>
                </tr>
              </thead>
              <tbody>
                <tr *nzFor="let user of usersTable.data">
                  <td>
                    <strong>{{ user.full_name || user.username }}</strong>
                    <div class="user-meta">{{ user.username }}</div>
                  </td>
                  <td>{{ user.email }}</td>
                  <td>
                    <nz-tag [nzColor]="getRoleColor(user.role_name)">
                      {{ user.role_name }}
                    </nz-tag>
                  </td>
                  <td>{{ formatDateTime(user.last_login) }}</td>
                  <td>
                    <nz-tag [nzColor]="user.is_active ? 'green' : 'red'">
                      {{ user.is_active ? i18n.t()('common.active') : i18n.t()('common.inactive') }}
                    </nz-tag>
                  </td>
                  <td class="action-buttons">
                    <button 
                      nz-button 
                      nzType="text" 
                      nzSize="small"
                      (click)="openUserModal(user)"
                      nz-tooltip 
                      [nzTooltipTitle]="i18n.t()('common.edit')">
                      <nz-icon nzType="edit"></nz-icon>
                    </button>
                    <button 
                      nz-button 
                      nzType="text" 
                      nzSize="small"
                      (click)="openUserRoleModal(user)"
                      nz-tooltip 
                      [nzTooltipTitle]="i18n.t()('user.change_role')">
                      <nz-icon nzType="team"></nz-icon>
                    </button>
                  </td>
                </tr>
              </tbody>
            </nz-table>

            <nz-empty *ngIf="users().length === 0 && !loading()" 
              [nzNotFoundContent]="i18n.t()('user.no_users_found')">
            </nz-empty>
          </div>
        </nz-tab>

        <!-- Permission Matrix Tab -->
        <nz-tab [nzTitle]="i18n.t()('tabs.permission_matrix')">
          <div class="tab-content">
            <div class="permission-matrix" *ngIf="permissionMatrix()">
              <nz-table 
                [nzData]="permissionMatrix()!.resources" 
                [nzLoading]="loading()"
                nzSize="middle"
                [nzPaginationPosition]="'none'"
                [nzScroll]="{ x: '1200px' }">
                <thead>
                  <tr>
                    <th nzLeft>{{ i18n.t()('permissions.resource') }}</th>
                    <th *nzFor="let role of permissionMatrix()!.roles">{{ role }}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *nzFor="let resource of permissionMatrix()!.resources">
                    <td nzLeft>
                      <strong>{{ resource }}</strong>
                    </td>
                    <td *nzFor="let role of permissionMatrix()!.roles">
                      <span *nzFor="let action of permissionMatrix()!.matrix[role][resource]">
                        <nz-tag 
                          [nzColor]="getPermissionActionColor(action)" 
                          class="permission-action-tag">
                          {{ action }}
                        </nz-tag>
                      </span>
                      <span *ngIf="permissionMatrix()!.matrix[role][resource].length === 0" 
                        class="no-permissions">
                        {{ i18n.t()('permissions.none') }}
                      </span>
                    </td>
                  </tr>
                </tbody>
              </nz-table>
            </div>

            <nz-empty *ngIf="!permissionMatrix() && !loading()" 
              [nzNotFoundContent]="i18n.t()('permissions.no_matrix_found')">
            </nz-empty>
          </div>
        </nz-tab>

      </nz-tabset>
    </nz-card>
  </div>
</div>

<!-- Role Modal -->
<nz-modal
  [(nzVisible)]="roleModalVisible"
  [nzTitle]="selectedRole() ? i18n.t()('role.edit_role') : i18n.t()('role.create_role')"
  [nzOkText]="i18n.t()('common.save')"
  [nzCancelText]="i18n.t()('common.cancel')"
  (nzOnOk)="saveRole()"
  (nzOnCancel)="cancelRoleModal()"
  nzWidth="600px">
  
  <ng-container *nzModalContent>
    <form nz-form [formGroup]="roleForm" nzLayout="vertical">
      <nz-form-item>
        <nz-form-label nzRequired>{{ i18n.t()('role.name') }}</nz-form-label>
        <nz-form-control nzErrorTip="Please enter role name">
          <input nz-input formControlName="name" [placeholder]="i18n.t()('role.name_placeholder')" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>{{ i18n.t()('role.description') }}</nz-form-label>
        <nz-form-control>
          <textarea 
            nz-input 
            formControlName="description" 
            [nzRows]="3"
            [placeholder]="i18n.t()('role.description_placeholder')">
          </textarea>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>

<!-- User Modal -->
<nz-modal
  [(nzVisible)]="userModalVisible"
  [nzTitle]="selectedUser() ? i18n.t()('user.edit_user') : i18n.t()('user.create_user')"
  [nzOkText]="i18n.t()('common.save')"
  [nzCancelText]="i18n.t()('common.cancel')"
  (nzOnOk)="saveUser()"
  (nzOnCancel)="cancelUserModal()"
  nzWidth="600px">
  
  <ng-container *nzModalContent>
    <form nz-form [formGroup]="userForm" nzLayout="vertical">
      <div nz-row [nzGutter]="16">
        <div nz-col [nzSpan]="12">
          <nz-form-item>
            <nz-form-label nzRequired>{{ i18n.t()('user.username') }}</nz-form-label>
            <nz-form-control nzErrorTip="Please enter username">
              <input nz-input formControlName="username" [placeholder]="i18n.t()('user.username_placeholder')" />
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col [nzSpan]="12">
          <nz-form-item>
            <nz-form-label nzRequired>{{ i18n.t()('user.email') }}</nz-form-label>
            <nz-form-control nzErrorTip="Please enter valid email">
              <input nz-input formControlName="email" type="email" [placeholder]="i18n.t()('user.email_placeholder')" />
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>

      <div nz-row [nzGutter]="16">
        <div nz-col [nzSpan]="12">
          <nz-form-item>
            <nz-form-label>{{ i18n.t()('user.first_name') }}</nz-form-label>
            <nz-form-control>
              <input nz-input formControlName="first_name" [placeholder]="i18n.t()('user.first_name_placeholder')" />
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col [nzSpan]="12">
          <nz-form-item>
            <nz-form-label>{{ i18n.t()('user.last_name') }}</nz-form-label>
            <nz-form-control>
              <input nz-input formControlName="last_name" [placeholder]="i18n.t()('user.last_name_placeholder')" />
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>

      <div nz-row [nzGutter]="16">
        <div nz-col [nzSpan]="12">
          <nz-form-item>
            <nz-form-label nzRequired>{{ i18n.t()('user.role') }}</nz-form-label>
            <nz-form-control nzErrorTip="Please select role">
              <nz-select formControlName="role" [nzPlaceHolder]="i18n.t()('user.select_role')">
                <nz-option *nzFor="let role of roles()" [nzValue]="role.id" [nzLabel]="role.name"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>
        <div nz-col [nzSpan]="12">
          <nz-form-item>
            <nz-form-label>{{ i18n.t()('common.status') }}</nz-form-label>
            <nz-form-control>
              <nz-switch 
                formControlName="is_active"
                [nzCheckedChildren]="i18n.t()('common.active')"
                [nzUnCheckedChildren]="i18n.t()('common.inactive')">
              </nz-switch>
            </nz-form-control>
          </nz-form-item>
        </div>
      </div>
    </form>
  </ng-container>
</nz-modal>

<!-- Permission Modal -->
<nz-modal
  [(nzVisible)]="permissionModalVisible"
  [nzTitle]="i18n.t()('permissions.manage_permissions')"
  [nzOkText]="i18n.t()('common.save')"
  [nzCancelText]="i18n.t()('common.cancel')"
  (nzOnOk)="savePermissions(selectedRole()!)"
  (nzOnCancel)="cancelPermissionModal()"
  nzWidth="800px">
  
  <ng-container *nzModalContent>
    <div class="permission-editor" *ngIf="selectedRole()">
      <nz-descriptions [nzTitle]="i18n.t()('role.details')" nzBordered>
        <nz-descriptions-item [nzTitle]="i18n.t()('role.name')">
          <nz-tag [nzColor]="getRoleColor(selectedRole()!.name)">
            {{ selectedRole()!.name }}
          </nz-tag>
        </nz-descriptions-item>
        <nz-descriptions-item [nzTitle]="i18n.t()('role.description')">
          {{ selectedRole()!.description }}
        </nz-descriptions-item>
      </nz-descriptions>

      <nz-divider></nz-divider>

      <div class="permission-categories">
        <div *nzFor="let category of permissionCategories" class="permission-category">
          <h4>
            <nz-icon [nzType]="category.icon"></nz-icon>
            {{ category.label }}
          </h4>
          <div class="permission-actions">
            <label 
              *nzFor="let action of permissionActions" 
              nz-checkbox 
              [nzChecked]="hasPermission(selectedRole()!, category.key, action.key)"
              (nzCheckedChange)="togglePermission(selectedRole()!, category.key, action.key)">
              <nz-tag [nzColor]="action.color" class="action-tag">{{ action.label }}</nz-tag>
            </label>
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</nz-modal>

<!-- User Role Change Modal -->
<nz-modal
  [(nzVisible)]="userRoleModalVisible"
  [nzTitle]="i18n.t()('user.change_role')"
  [nzOkText]="i18n.t()('common.save')"
  [nzCancelText]="i18n.t()('common.cancel')"
  (nzOnOk)="changeUserRole()"
  (nzOnCancel)="cancelUserRoleModal()"
  nzWidth="500px">
  
  <ng-container *nzModalContent>
    <form nz-form [formGroup]="userRoleForm" nzLayout="vertical">
      <nz-form-item>
        <nz-form-label nzRequired>{{ i18n.t()('user.new_role') }}</nz-form-label>
        <nz-form-control nzErrorTip="Please select new role">
          <nz-select formControlName="role_id" [nzPlaceHolder]="i18n.t()('user.select_new_role')">
            <nz-option *nzFor="let role of roles()" [nzValue]="role.id" [nzLabel]="role.name"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>{{ i18n.t()('user.change_reason') }}</nz-form-label>
        <nz-form-control>
          <textarea 
            nz-input 
            formControlName="reason" 
            [nzRows]="3"
            [placeholder]="i18n.t()('user.change_reason_placeholder')">
          </textarea>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>
